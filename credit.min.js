(function() {
  'use strict';
  
  const TeleBotHost = (function() {
    const VERSION = '1.0.0';
    const BADGE_ID = 'tbh_' + Math.random().toString(36).substr(2, 12);
    const CORNERS = ['bottom-right', 'bottom-left', 'top-right', 'top-left'];
    
    const config = {
      position: 'bottom-right',
      theme: 'default'
    };
    
    const styles = {
      default: {
        background: 'rgba(255, 255, 255, 0.95)',
        color: '#1a1a1a',
        border: '1.5px solid rgba(224, 224, 224, 0.8)',
        shadow: '0 6px 20px rgba(0, 0, 0, 0.12)',
        backdrop: 'blur(12px) saturate(180%)'
      },
      dark: {
        background: 'rgba(26, 26, 26, 0.95)',
        color: '#ffffff',
        border: '1.5px solid rgba(64, 64, 64, 0.8)',
        shadow: '0 6px 20px rgba(0, 0, 0, 0.25)',
        backdrop: 'blur(12px) saturate(180%)'
      },
      minimal: {
        background: 'rgba(255, 255, 255, 0.85)',
        color: '#666666',
        border: '1.5px solid rgba(224, 224, 224, 0.6)',
        shadow: '0 4px 12px rgba(0, 0, 0, 0.08)',
        backdrop: 'blur(8px) saturate(160%)'
      }
    };
    
    function calculateMaxZIndex() {
      let maxZ = 0;
      const allElements = document.querySelectorAll('*');
      
      allElements.forEach(element => {
        const zIndex = parseInt(window.getComputedStyle(element).zIndex);
        if (!isNaN(zIndex) && zIndex > maxZ) {
          maxZ = zIndex;
        }
      });
      
      return maxZ + 10;
    }
    
    function initialize() {
      mergeConfig();
      createBadge();
      setupProtection();
      setupResponsive();
    }
    
    function mergeConfig() {
      if (window.TeleBotHostConfig) {
        Object.assign(config, window.TeleBotHostConfig);
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const urlPosition = urlParams.get('tbh_position');
      if (urlPosition && CORNERS.includes(urlPosition)) {
        config.position = urlPosition;
      }
      
      if (!CORNERS.includes(config.position)) {
        config.position = 'bottom-right';
      }
      
      if (!styles[config.theme]) {
        config.theme = 'default';
      }
    }
    
    function createBadge() {
      if (document.getElementById(BADGE_ID)) return;
      
      const badge = document.createElement('div');
      badge.id = BADGE_ID;
      badge.className = BADGE_ID;
      
      const style = styles[config.theme];
      const calculatedZIndex = calculateMaxZIndex();
      
      const badgeStyle = document.createElement('style');
      badgeStyle.textContent = `
                #${BADGE_ID} {
                    position: fixed !important;
                    background: ${style.background} !important;
                    padding: 8px 14px !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                    border-radius: 12px !important;
                    box-shadow: ${style.shadow} !important;
                    border: ${style.border} !important;
                    font-weight: 500 !important;
                    font-size: 13px !important;
                    color: ${style.color} !important;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                    z-index: ${calculatedZIndex} !important;
                    cursor: pointer !important;
                    overflow: hidden !important;
                    user-select: none !important;
                    transition: all 0.2s ease !important;
                    backdrop-filter: ${style.backdrop} !important;
                    -webkit-backdrop-filter: ${style.backdrop} !important;
                    box-sizing: border-box !important;
                }
                
                #${BADGE_ID}:hover {
                    transform: translateY(-1px) !important;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
                    backdrop-filter: ${style.backdrop.replace('blur(12px)', 'blur(16px)').replace('blur(8px)', 'blur(12px)')} !important;
                    -webkit-backdrop-filter: ${style.backdrop.replace('blur(12px)', 'blur(16px)').replace('blur(8px)', 'blur(12px)')} !important;
                }
                
                #${BADGE_ID} img {
                    width: 20px !important;
                    height: 20px !important;
                    border-radius: 6px !important;
                    flex-shrink: 0 !important;
                    display: block !important;
                }
                
                #${BADGE_ID} span {
                    white-space: nowrap !important;
                    font-size: 12px !important;
                    letter-spacing: -0.2px !important;
                }
                
                #${BADGE_ID} a {
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    opacity: 0 !important;
                }
                
                @media (max-width: 480px) {
                    #${BADGE_ID} {
                        padding: 6px 10px !important;
                        font-size: 11px !important;
                        gap: 6px !important;
                    }
                    
                    #${BADGE_ID} img {
                        width: 16px !important;
                        height: 16px !important;
                    }
                    
                    #${BADGE_ID} span {
                        font-size: 10px !important;
                    }
                }
            `;
      
      document.head.appendChild(badgeStyle);
      
      applyPosition(badge);
      
      const logo = document.createElement('img');
      logo.src = 'https://telebothost.com/logo.png';
      logo.alt = 'TeleBotHost';
      
      const text = document.createElement('span');
      text.textContent = 'Built with TeleBotHost';
      
      const link = document.createElement('a');
      link.href = 'https://telebothost.com/';
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      
      badge.appendChild(logo);
      badge.appendChild(text);
      badge.appendChild(link);
      
      document.body.appendChild(badge);
    }
    
    function applyPosition(element) {
      const positions = {
        'bottom-right': { bottom: '12px', right: '12px' },
        'bottom-left': { bottom: '12px', left: '12px' },
        'top-right': { top: '12px', right: '12px' },
        'top-left': { top: '12px', left: '12px' }
      };
      
      const position = positions[config.position] || positions['bottom-right'];
      Object.assign(element.style, {
        bottom: position.bottom ? position.bottom + ' !important' : '',
        top: position.top ? position.top + ' !important' : '',
        left: position.left ? position.left + ' !important' : '',
        right: position.right ? position.right + ' !important' : ''
      });
    }
    
    function setupResponsive() {
      const checkViewport = () => {
        const badge = document.getElementById(BADGE_ID);
        if (!badge) return;
        
        if (window.innerWidth <= 480) {
          const positions = {
            'bottom-right': { bottom: '8px', right: '8px' },
            'bottom-left': { bottom: '8px', left: '8px' },
            'top-right': { top: '8px', right: '8px' },
            'top-left': { top: '8px', left: '8px' }
          };
          
          const position = positions[config.position] || positions['bottom-right'];
          Object.assign(badge.style, {
            bottom: position.bottom ? position.bottom + ' !important' : '',
            top: position.top ? position.top + ' !important' : '',
            left: position.left ? position.left + ' !important' : '',
            right: position.right ? position.right + ' !important' : ''
          });
        } else {
          applyPosition(badge);
        }
      };
      
      window.addEventListener('resize', checkViewport);
      checkViewport();
    }
    
    function setupProtection() {
      const observer = new MutationObserver(function(mutations) {
        const badge = document.getElementById(BADGE_ID);
        if (!badge) {
          createBadge();
        } else {
          const currentZIndex = parseInt(window.getComputedStyle(badge).zIndex);
          const maxZIndex = calculateMaxZIndex();
          if (currentZIndex < maxZIndex) {
            badge.style.zIndex = maxZIndex + ' !important';
          }
          
          const link = badge.querySelector('a');
          if (link && (link.href !== 'https://telebothost.com/' || link.target !== '_blank')) {
            link.href = 'https://telebothost.com/';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
          }
          
          const img = badge.querySelector('img');
          if (img && img.src !== 'https://telebothost.com/logo.png') {
            img.src = 'https://telebothost.com/logo.png';
          }
          
          const text = badge.querySelector('span');
          if (text && text.textContent !== 'Built with TeleBotHost') {
            text.textContent = 'Built with TeleBotHost';
          }
        }
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class', 'href', 'target', 'src']
      });
      
      setInterval(() => {
        const badge = document.getElementById(BADGE_ID);
        if (badge) {
          const maxZIndex = calculateMaxZIndex();
          const currentZIndex = parseInt(window.getComputedStyle(badge).zIndex);
          if (currentZIndex < maxZIndex) {
            badge.style.zIndex = maxZIndex + ' !important';
          }
        }
      }, 500);
    }
    
    return {
      init: initialize,
      version: VERSION
    };
  })();
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', TeleBotHost.init);
  } else {
    TeleBotHost.init();
  }
  
  window.TeleBotHost = TeleBotHost;
})();